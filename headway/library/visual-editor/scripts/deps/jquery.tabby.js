(function(e){function t(e){window.console&&window.console.log&&window.console.log("textarea count: "+e.size())}function n(e,t,n){var s=e.scrollTop;e.setSelectionRange?r(e,t,n):document.selection&&i(e,t,n),e.scrollTop=s}function r(e,t,n){var r=e.selectionStart,i=e.selectionEnd;if(r==i)t?r-n.tabString==e.value.substring(r-n.tabString.length,r)?(e.value=e.value.substring(0,r-n.tabString.length)+e.value.substring(r),e.focus(),e.setSelectionRange(r-n.tabString.length,r-n.tabString.length)):r-n.tabString==e.value.substring(r,r+n.tabString.length)&&(e.value=e.value.substring(0,r)+e.value.substring(r+n.tabString.length),e.focus(),e.setSelectionRange(r,r)):(e.value=e.value.substring(0,r)+n.tabString+e.value.substring(r),e.focus(),e.setSelectionRange(r+n.tabString.length,r+n.tabString.length));else{while(r<e.value.length&&e.value.charAt(r).match(/[ \t]/))r++;var s=e.value.split("\n"),o=new Array,u=0,a=0,f=!1;for(var l in s)a=u+s[l].length,o.push({start:u,end:a,selected:u<=r&&a>r||a>=i&&u<i||u>r&&a<i}),u=a+1;var c=0;for(var l in o)if(o[l].selected){var h=o[l].start+c;t&&n.tabString==e.value.substring(h,h+n.tabString.length)?(e.value=e.value.substring(0,h)+e.value.substring(h+n.tabString.length),c-=n.tabString.length):t||(e.value=e.value.substring(0,h)+n.tabString+e.value.substring(h),c+=n.tabString.length)}e.focus();var p=r+(c>0?n.tabString.length:c<0?-n.tabString.length:0),d=i+c;e.setSelectionRange(p,d)}}function i(t,n,r){var i=document.selection.createRange();if(t==i.parentElement())if(""==i.text)if(n){var s=i.getBookmark();i.moveStart("character",-r.tabString.length),r.tabString==i.text?i.text="":(i.moveToBookmark(s),i.moveEnd("character",r.tabString.length),r.tabString==i.text&&(i.text="")),i.collapse(!0),i.select()}else i.text=r.tabString,i.collapse(!1),i.select();else{var o=i.text,u=o.length,a=o.split("\r\n"),f=document.body.createTextRange();f.moveToElementText(t),f.setEndPoint("EndToStart",i);var l=f.text,c=l.split("\r\n"),h=l.length,p=document.body.createTextRange();p.moveToElementText(t),p.setEndPoint("StartToEnd",i);var v=p.text,m=document.body.createTextRange();m.moveToElementText(t),m.setEndPoint("StartToEnd",f);var g=m.text,y=e(t).html();e("#r3").text(h+" + "+u+" + "+v.length+" = "+y.length),h+g.length<y.length?(c.push(""),h+=2,n&&r.tabString==a[0].substring(0,r.tabString.length)?a[0]=a[0].substring(r.tabString.length):n||(a[0]=r.tabString+a[0])):n&&r.tabString==c[c.length-1].substring(0,r.tabString.length)?c[c.length-1]=c[c.length-1].substring(r.tabString.length):n||(c[c.length-1]=r.tabString+c[c.length-1]);for(var b=1;b<a.length;b++)n&&r.tabString==a[b].substring(0,r.tabString.length)?a[b]=a[b].substring(r.tabString.length):n||(a[b]=r.tabString+a[b]);1==c.length&&0==h&&(n&&r.tabString==a[0].substring(0,r.tabString.length)?a[0]=a[0].substring(r.tabString.length):n||(a[0]=r.tabString+a[0])),h+u+v.length<y.length&&(a.push(""),u+=2),f.text=c.join("\r\n"),i.text=a.join("\r\n");var w=document.body.createTextRange();w.moveToElementText(t),0<h?w.setEndPoint("StartToEnd",f):w.setEndPoint("StartToStart",f),w.setEndPoint("EndToEnd",i),w.select()}}e.fn.tabby=function(t){var r=e.extend({},e.fn.tabby.defaults,t),i=e.fn.tabby.pressed;return this.each(function(){$this=e(this);var t=e.meta?e.extend({},r,$this.data()):r;$this.bind("keydown",function(r){var s=e.fn.tabby.catch_kc(r);16==s&&(i.shft=!0),17==s&&(i.ctrl=!0,setTimeout("$.fn.tabby.pressed.ctrl = false;",1e3)),18==s&&(i.alt=!0,setTimeout("$.fn.tabby.pressed.alt = false;",1e3));if(9==s&&!i.ctrl&&!i.alt)return r.preventDefault,i.last=s,setTimeout("$.fn.tabby.pressed.last = null;",0),n(e(r.target).get(0),i.shft,t),!1}).bind("keyup",function(t){16==e.fn.tabby.catch_kc(t)&&(i.shft=!1)}).bind("blur",function(t){9==i.last&&e(t.target).one("focus",function(e){i.last=null}).get(0).focus()})})},e.fn.tabby.catch_kc=function(e){return e.keyCode?e.keyCode:e.charCode?e.charCode:e.which},e.fn.tabby.pressed={shft:!1,ctrl:!1,alt:!1,last:null},e.fn.tabby.defaults={tabString:String.fromCharCode(9)}})(jQuery);